# Cursor Rules for Music Soup - Playlist Sync Automation

## ğŸ¯ Project Overview
This is a Node.js automation that syncs Apple Music and Spotify playlists into a Notion database. All code should align with the PRD requirements for flexibility, modularity, and API safety.

## ğŸ“ Required Directory Structure
Enforce the following project organization:

```
/
â”œâ”€â”€ config.js                 # Centralized environment variable access
â”œâ”€â”€ endpoints.js              # All API endpoint constants
â”œâ”€â”€ schema.js                 # Notion schema and response field definitions
â”œâ”€â”€ spotifyClient.js          # Spotify API integration only
â”œâ”€â”€ appleMusicClient.js       # Apple Music API integration only
â”œâ”€â”€ notionClient.js           # Notion API integration only
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ logger.js            # Central logging with levels (info, warn, error)
â”‚   â””â”€â”€ [other helpers]      # Shared utilities (deduplication, date formatting, etc.)
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ spotify.test.js      # Integration test stubs for Spotify
â”‚   â”œâ”€â”€ appleMusic.test.js   # Integration test stubs for Apple Music
â”‚   â””â”€â”€ notion.test.js       # Integration test stubs for Notion
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ [utility scripts]   # One-off helpers (token generation, etc.)
â””â”€â”€ .github/workflows/       # GitHub Actions workflows
```

## ğŸ” Secrets Management Rules

### FORBIDDEN:
- âŒ Hardcoding API keys, tokens, or private keys anywhere in code
- âŒ Direct `process.env` calls outside of `config.js`
- âŒ Committing sensitive values to Git

### REQUIRED:
- âœ… All environment variables MUST be accessed through `config.js`
- âœ… Sensitive values MUST come from `.env` or GitHub Secrets
- âœ… Private keys must preserve line breaks and proper formatting
- âœ… Example `.env` template in README.md (with fake values)

## ğŸŒ API Safety & Anti-Hallucination Rules

### Endpoint Validation:
- âœ… ALL API endpoints MUST match official documentation:
  - Spotify: https://developer.spotify.com/documentation/web-api/
  - Apple Music: https://developer.apple.com/documentation/applemusicapi/
  - Notion: https://developers.notion.com/reference/
- âœ… Custom endpoints MUST be declared as constants in `endpoints.js`
- âœ… Every external API call MUST include inline comment with link to API docs

### Schema Safety:
- âœ… New Notion fields MUST be explicitly added to `schema.js` first
- âœ… Response parsing MUST reference `schema.js` field definitions
- âœ… Handle missing metadata gracefully (log gaps, don't crash)

### Example Required Format:
```javascript
// Spotify Get Playlist Tracks: https://developer.spotify.com/documentation/web-api/reference/get-playlists-tracks
const response = await fetch(`${ENDPOINTS.SPOTIFY_PLAYLIST_TRACKS}/${playlistId}/tracks`);
```

## ğŸ—ï¸ Code Organization Rules

### File Responsibilities:
- `spotifyClient.js`: ONLY Spotify API calls and auth
- `appleMusicClient.js`: ONLY Apple Music API calls and auth  
- `notionClient.js`: ONLY Notion API calls and database operations
- `config.js`: ONLY environment variable access and validation
- `endpoints.js`: ONLY API endpoint constants
- `schema.js`: ONLY data structure definitions

### Modularity Requirements:
- âœ… Each API client must be independently testable
- âœ… No cross-dependencies between API clients
- âœ… Shared logic goes in `utils/` directory
- âœ… Each file MUST have a docstring explaining its purpose

## ğŸ›¡ï¸ Error Handling & Logging

### Required Patterns:
- âœ… Every API call MUST include try-catch with specific error messages
- âœ… All logging MUST go through `utils/logger.js` with proper levels
- âœ… Rate limiting and retry logic for external APIs
- âœ… Graceful degradation when metadata is missing

### Example Required Format:
```javascript
try {
  // Spotify Get Track: https://developer.spotify.com/documentation/web-api/reference/get-track
  const response = await spotifyRequest(url);
  logger.info(`Successfully fetched track: ${trackId}`);
} catch (error) {
  logger.error(`Failed to fetch Spotify track ${trackId}: ${error.message}`);
  // Handle gracefully - don't crash the sync
}
```

## ğŸ“Š PRD Alignment Reminders

### Data Handling:
- âœ… Notion URL field stores BOTH Spotify AND Apple Music URLs in same property
- âœ… Use ISRC as primary key for deduplication when available
- âœ… Handle incomplete metadata mappings between services
- âœ… Preserve flexibility for future metadata enrichment

### Workflow Requirements:
- âœ… Support serverless execution via GitHub Actions
- âœ… Allow manual tagging in Notion (don't overwrite human-added fields)
- âœ… Log sync summaries and metadata gaps for monitoring

## ğŸ§ª Testing Requirements

### Test Structure:
- âœ… Integration test stubs MUST exist for each API client
- âœ… Tests should verify auth flows and basic data retrieval
- âœ… Mock external API calls to avoid hitting rate limits
- âœ… Test error handling scenarios

## ğŸ“ Documentation Requirements

### File Documentation:
- âœ… Every file MUST start with a docstring explaining its purpose
- âœ… Complex functions MUST have JSDoc comments
- âœ… README.md MUST include setup instructions and example `.env`

### Example Required Docstring:
```javascript
/**
 * Spotify API Client
 * 
 * Handles all Spotify Web API interactions including authentication,
 * playlist fetching, and track metadata retrieval.
 * 
 * Dependencies: config.js for credentials, utils/logger.js for logging
 * API Docs: https://developer.spotify.com/documentation/web-api/
 */
```

## ğŸš€ GitHub Actions Requirements

### Workflow Organization:
- âœ… All workflows MUST be in `.github/workflows/`
- âœ… Secrets MUST be loaded from GitHub Secrets, not hardcoded
- âœ… Include error notifications and run summaries
- âœ… Support manual triggers for testing

## âš¡ Performance & Reliability

### Required Patterns:
- âœ… Implement exponential backoff for API retries
- âœ… Batch operations where possible to respect rate limits
- âœ… Cache tokens and refresh only when necessary
- âœ… Graceful handling of API downtime

## ğŸµ Music-Specific Considerations

### Apple Music Specifics:
- âœ… Handle both Developer Token and Music User Token requirements
- âœ… Include storefront parameter in all requests
- âœ… Parse playlist URLs correctly for playlist IDs

### Spotify Specifics:
- âœ… Implement OAuth refresh token flow
- âœ… Handle pagination for large playlists
- âœ… Extract playlist IDs from Spotify URLs correctly

### Cross-Platform:
- âœ… Normalize metadata schemas between services
- âœ… Handle different field names gracefully (e.g., Composer vs Artist)
- âœ… Store both service URLs in same Notion field

---

Remember: This automation should be robust enough to run unattended while flexible enough to handle the quirks of music metadata across different platforms.
